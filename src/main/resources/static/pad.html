<!doctype html>
<html lang="it">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Pad Ordini</title></head>
<body>
<h1>Nuovo ordine</h1>
<div id="menu"></div>
<p>Totale: <strong id="tot">0.00</strong> €</p>
<label>Dividi per N: <input id="splitN" type="number" min="1" value="1"></label>
<p>Quota per persona: <strong id="split">0.00</strong> €</p>
<label>Tavolo <input id="tableNo"></label>
<label>Note <input id="notes"></label>
<button id="save">Invia ordine</button>
<pre id="result"></pre>
<script>
const menuEl = document.getElementById('menu');
let dishes = [];

function money(v){ return Number(v||0).toFixed(2); }
function recalc(){
  let total=0;
  dishes.forEach(d=>{
    const q = Number(document.getElementById('q'+d.id).value||0);
    const line = q*Number(d.price);
    document.getElementById('l'+d.id).textContent = money(line);
    total += line;
  });
  document.getElementById('tot').textContent = money(total);
  const n = Math.max(1, Number(document.getElementById('splitN').value||1));
  document.getElementById('split').textContent = money(total/n);
}

async function loadMenu(){
  const res = await fetch('/getPiatti');
  dishes = await res.json();
  menuEl.innerHTML = dishes.map(d => `<div>${d.name} (${money(d.price)} €) x <input id="q${d.id}" type="number" min="0" value="0" style="width:70px"> = <span id="l${d.id}">0.00</span> €</div>`).join('');
  dishes.forEach(d => document.getElementById('q'+d.id).addEventListener('input', recalc));
  document.getElementById('splitN').addEventListener('input', recalc);
  recalc();
}

async function saveOrder(){
  const items = dishes.map((d,pos)=>({dishId:d.id, qty:Number(document.getElementById('q'+d.id).value||0), position:pos})).filter(i=>i.qty>0);
  if(!items.length){ alert('Seleziona almeno un piatto'); return; }
  const payload = { tableNo: document.getElementById('tableNo').value, notes: document.getElementById('notes').value, status:'NEW', items };
  const res = await fetch('/setordine', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const data = await res.json();
  document.getElementById('result').textContent = JSON.stringify(data, null, 2);
}

document.getElementById('save').addEventListener('click', saveOrder);
loadMenu();
</script>
</body>
</html>
