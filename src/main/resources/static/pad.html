<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pad Ordini</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --card-2:#19233c; --text:#eaf0ff; --muted:#9fb0d9;
      --primary:#5b8cff; --primary-2:#7aa2ff; --danger:#ef4444; --border:#2a3b63;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a1020 50%,#0b1220);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:980px;margin:20px auto;padding:0 16px}
    .card{background:rgba(17,26,46,.95);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:0 12px 40px rgba(0,0,0,.28)}
    h1,h2{margin:0 0 14px}
    h2{margin-top:0;font-size:1.2rem}
    .grid{display:grid;grid-template-columns:1fr 110px 120px;gap:10px;align-items:center}
    .dish{padding:10px;border:1px solid #24365b;border-radius:10px;background:var(--card-2)}
    .muted{color:var(--muted)}
    .qty-wrap{display:flex;align-items:center;gap:6px}
    .qty-val{min-width:28px;text-align:center;padding:8px 6px;border-radius:8px;border:1px solid #304674;background:#0f172a}
    .qty-btn{width:36px;height:36px;border:1px solid #38548a;background:#0f172a;color:#fff;border-radius:10px;font-size:20px;cursor:pointer;line-height:1}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #304674;background:#0f172a;color:var(--text)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    .summary{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px}
    .pill{background:#0f172a;border:1px solid #29416f;border-radius:999px;padding:10px 14px;font-weight:600}
    .btn{border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:.18s transform,.18s filter}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid #38548a}
    .btn-danger{background:var(--danger);color:#fff}
    pre{white-space:pre-wrap;background:#0f172a;border:1px solid #29416f;border-radius:12px;padding:10px;margin-top:12px;color:#9fe870}
    .orders{display:grid;gap:10px}
    .order{border:1px solid #274375;border-radius:12px;padding:10px;background:#0f172a}
    .order-head{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .small{font-size:.9rem}
    .actions{display:flex;gap:8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="formTitle">Nuovo ordine</h1>
    <div id="menu" class="grid"></div>

    <div class="summary">
      <div class="pill">Totale: <strong id="tot">0.00</strong> €</div>
      <div class="pill">Quota per persona: <strong id="split">0.00</strong> €</div>
    </div>

    <div class="row">
      <label>Dividi per N
        <input id="splitN" type="number" min="1" value="1">
      </label>
      <label>Tavolo
        <input id="tableNo" placeholder="es. 12">
      </label>
    </div>

    <div class="row">
      <label style="grid-column:1/-1">Note ordine (salvate su DB)
        <input id="notes" placeholder="Es. 1 senza lattosio, pane extra...">
      </label>
    </div>

    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary" id="save">Invia ordine</button>
      <button class="btn btn-ghost" id="reset">Reset</button>
      <button class="btn btn-danger" id="cancelEdit" style="display:none">Annulla modifica</button>
    </div>

    <pre id="result"></pre>
  </div>

  <div class="card" style="margin-top:14px">
    <h2>Ordini recenti</h2>
    <div id="orders" class="orders"></div>
  </div>
</div>

<script>
const menuEl = document.getElementById('menu');
const ordersEl = document.getElementById('orders');
let dishes = [];
let currentEditOrderId = null;
const qtyByDishId = {};

function money(v){ return Number(v||0).toFixed(2); }

function setQty(dishId, qty){
  qtyByDishId[dishId] = Math.max(0, qty);
  const qEl = document.getElementById('q'+dishId);
  if (qEl) qEl.textContent = qtyByDishId[dishId];
  recalc();
}

function changeQty(dishId, delta){
  const current = qtyByDishId[dishId] || 0;
  setQty(dishId, current + delta);
}

function recalc(){
  let total=0;
  dishes.forEach(d=>{
    const q = qtyByDishId[d.id] || 0;
    const line = q*Number(d.price);
    document.getElementById('l'+d.id).textContent = money(line);
    total += line;
  });
  document.getElementById('tot').textContent = money(total);
  const n = Math.max(1, Number(document.getElementById('splitN').value||1));
  document.getElementById('split').textContent = money(total/n);
}

function renderMenu(){
  menuEl.innerHTML = dishes.map(d => `
    <div class="dish">
      <div><strong>${d.name}</strong></div>
      <div class="muted">${money(d.price)} €</div>
    </div>
    <div class="qty-wrap">
      <button class="qty-btn" onclick="changeQty(${d.id},1)">+</button>
      <button class="qty-btn" onclick="changeQty(${d.id},-1)">−</button>
      <div class="qty-val" id="q${d.id}">0</div>
    </div>
    <div class="dish"><span id="l${d.id}">0.00</span> €</div>
  `).join('');
  recalc();
}

async function loadMenu(){
  const res = await fetch('/getPiatti');
  dishes = await res.json();
  dishes.forEach(d => { if (qtyByDishId[d.id] == null) qtyByDishId[d.id] = 0; });
  renderMenu();
  document.getElementById('splitN').addEventListener('input', recalc);
}

function clearQuantities(){
  dishes.forEach(d => setQty(d.id, 0));
}

async function saveOrder(){
  const items = dishes.map((d,pos)=>({dishId:d.id, qty:qtyByDishId[d.id] || 0, position:pos})).filter(i=>i.qty>0);
  if(!items.length){ alert('Seleziona almeno un piatto'); return; }

  const payload = {
    id: currentEditOrderId,
    tableNo: document.getElementById('tableNo').value,
    notes: document.getElementById('notes').value,
    status:'NEW',
    items
  };

  const res = await fetch('/setordine', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const data = await res.json();
  document.getElementById('result').textContent = JSON.stringify(data, null, 2);
  resetForm();
  await loadOrders();
}

function resetForm(){
  currentEditOrderId = null;
  document.getElementById('formTitle').textContent = 'Nuovo ordine';
  document.getElementById('save').textContent = 'Invia ordine';
  document.getElementById('cancelEdit').style.display = 'none';
  clearQuantities();
  document.getElementById('splitN').value = 1;
  document.getElementById('tableNo').value = '';
  document.getElementById('notes').value = '';
  document.getElementById('result').textContent = '';
  recalc();
}

function beginEdit(order){
  currentEditOrderId = order.id;
  document.getElementById('formTitle').textContent = `Modifica ordine ${order.id}`;
  document.getElementById('save').textContent = 'Salva modifica';
  document.getElementById('cancelEdit').style.display = 'inline-block';

  clearQuantities();
  const dishByName = Object.fromEntries(dishes.map(d => [String(d.name).toLowerCase(), d]));
  (order.items || []).forEach(it => {
    const dish = dishByName[String(it.name || '').toLowerCase()];
    if (dish) setQty(dish.id, Number(it.qty || 0));
  });
  document.getElementById('tableNo').value = order.tableNo || '';
  document.getElementById('notes').value = order.notes || '';
  recalc();
  window.scrollTo({top:0, behavior:'smooth'});
}

async function deleteOrder(id){
  if(!confirm('Eliminare questo ordine annullato?')) return;
  await fetch('/deleteordine/'+encodeURIComponent(id), { method:'DELETE' });
  if (currentEditOrderId === id) resetForm();
  await loadOrders();
}

function renderOrders(list){
  ordersEl.innerHTML = list.map(o => `
    <div class="order">
      <div class="order-head">
        <div>
          <strong>Ordine ${o.id}</strong> • Tavolo <b>${o.tableNo || '-'}</b> • Totale <b>${o.totalAmount} €</b>
          <div class="small muted">Note: ${o.notes ? o.notes : '—'}</div>
        </div>
        <div class="actions">
          <button class="btn btn-ghost" onclick='startEdit("${o.id}")'>Modifica</button>
          <button class="btn btn-danger" onclick='deleteOrder("${o.id}")'>Elimina</button>
        </div>
      </div>
      <div class="small muted" style="margin-top:6px">${(o.items||[]).map(i=>`${i.name} x${i.qty} (${i.lineTotal}€)`).join(' • ')}</div>
    </div>
  `).join('');
  window._ordersCache = list;
}

function startEdit(orderId){
  const order = (window._ordersCache || []).find(o => o.id === orderId);
  if (order) beginEdit(order);
}

async function loadOrders(){
  const list = await fetch('/getordini?status=NEW,IN_PROGRESS,READY,DONE&sinceMinutes=1440').then(r => r.json());
  list.sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
  renderOrders(list);
}

window.changeQty = changeQty;
window.deleteOrder = deleteOrder;
window.startEdit = startEdit;

document.getElementById('save').addEventListener('click', saveOrder);
document.getElementById('reset').addEventListener('click', resetForm);
document.getElementById('cancelEdit').addEventListener('click', resetForm);

(async function init(){
  await loadMenu();
  await loadOrders();
  setInterval(loadOrders, 5000);
})();
</script>
</body>
</html>
