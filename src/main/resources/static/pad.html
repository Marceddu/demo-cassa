<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pad Ordini</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --card-2:#19233c; --text:#eaf0ff; --muted:#9fb0d9;
      --primary:#5b8cff; --primary-2:#7aa2ff; --ok:#22c55e; --danger:#ef4444; --border:#2a3b63;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a1020 50%,#0b1220);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:rgba(17,26,46,.95);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:0 12px 40px rgba(0,0,0,.28)}
    h1{margin:0 0 14px;font-size:1.45rem}
    .grid{display:grid;grid-template-columns:1fr 110px 120px;gap:10px;align-items:center}
    .dish{padding:10px;border:1px solid #24365b;border-radius:10px;background:var(--card-2)}
    .muted{color:var(--muted)}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #304674;background:#0f172a;color:var(--text)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    .summary{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px}
    .pill{background:#0f172a;border:1px solid #29416f;border-radius:999px;padding:10px 14px;font-weight:600}
    .btn{border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:.18s transform,.18s opacity,.18s filter}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .btn:active{transform:translateY(0)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid #38548a}
    pre{white-space:pre-wrap;background:#0f172a;border:1px solid #29416f;border-radius:12px;padding:10px;margin-top:12px;color:#9fe870}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Nuovo ordine</h1>
    <div id="menu" class="grid"></div>

    <div class="summary">
      <div class="pill">Totale: <strong id="tot">0.00</strong> €</div>
      <div class="pill">Quota per persona: <strong id="split">0.00</strong> €</div>
    </div>

    <div class="row">
      <label>Dividi per N
        <input id="splitN" type="number" min="1" value="1">
      </label>
      <label>Tavolo
        <input id="tableNo" placeholder="es. 12">
      </label>
    </div>

    <div class="row">
      <label style="grid-column:1/-1">Note
        <input id="notes" placeholder="Note ordine">
      </label>
    </div>

    <div style="margin-top:14px;display:flex;gap:8px">
      <button class="btn btn-primary" id="save">Invia ordine</button>
      <button class="btn btn-ghost" id="reset">Reset</button>
    </div>

    <pre id="result"></pre>
  </div>
</div>

<script>
const menuEl = document.getElementById('menu');
let dishes = [];

function money(v){ return Number(v||0).toFixed(2); }
function recalc(){
  let total=0;
  dishes.forEach(d=>{
    const q = Number(document.getElementById('q'+d.id).value||0);
    const line = q*Number(d.price);
    document.getElementById('l'+d.id).textContent = money(line);
    total += line;
  });
  document.getElementById('tot').textContent = money(total);
  const n = Math.max(1, Number(document.getElementById('splitN').value||1));
  document.getElementById('split').textContent = money(total/n);
}

async function loadMenu(){
  const res = await fetch('/getPiatti');
  dishes = await res.json();
  menuEl.innerHTML = dishes.map(d => `
    <div class="dish">
      <div><strong>${d.name}</strong></div>
      <div class="muted">${money(d.price)} €</div>
    </div>
    <input id="q${d.id}" type="number" min="0" value="0">
    <div class="dish"><span id="l${d.id}">0.00</span> €</div>
  `).join('');
  dishes.forEach(d => document.getElementById('q'+d.id).addEventListener('input', recalc));
  document.getElementById('splitN').addEventListener('input', recalc);
  recalc();
}

async function saveOrder(){
  const items = dishes.map((d,pos)=>({dishId:d.id, qty:Number(document.getElementById('q'+d.id).value||0), position:pos})).filter(i=>i.qty>0);
  if(!items.length){ alert('Seleziona almeno un piatto'); return; }
  const payload = { tableNo: document.getElementById('tableNo').value, notes: document.getElementById('notes').value, status:'NEW', items };
  const res = await fetch('/setordine', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const data = await res.json();
  document.getElementById('result').textContent = JSON.stringify(data, null, 2);
}

function resetForm(){
  dishes.forEach(d => { document.getElementById('q'+d.id).value = 0; });
  document.getElementById('splitN').value = 1;
  document.getElementById('tableNo').value = '';
  document.getElementById('notes').value = '';
  document.getElementById('result').textContent = '';
  recalc();
}

document.getElementById('save').addEventListener('click', saveOrder);
document.getElementById('reset').addEventListener('click', resetForm);
loadMenu();
</script>
</body>
</html>
