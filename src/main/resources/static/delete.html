<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Coda Ordini • Elimina/Consegnato</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#000; --fg:#fff; --card:#111; --border:#2a2a2a;
      --ok:#16a34a; --okText:#000; --danger:#ef4444; --muted:#374151;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;align-items:center;gap:12px;padding:14px}
    h1{margin:0;font-size:20px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    select,button{font-size:16px}
    .btn{border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.reload{background:var(--muted);color:#fff}
    .list{padding:14px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#1b1b1b;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px}
    .actions{display:flex;gap:8px}
    .btn-ok{background:var(--ok);color:var(--okText);font-weight:700}
    .btn-del{background:var(--danger);color:#fff;font-weight:700}
    .items{opacity:.9;font-size:14px;margin-top:6px}
    .small{opacity:.7;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Coda ordini</h1>
    <div class="controls">
      <label class="small" for="stati">stati:</label>
      <select id="stati">
        <option value="NEW,IN_PROGRESS,READY">Attivi (NEW/IN_PROGRESS/READY)</option>
        <option value="NEW,IN_PROGRESS,READY,DONE">Tutti (incl. DONE)</option>
      </select>
      <button class="btn reload" id="refreshBtn">aggiorna</button>
    </div>
  </header>

  <div id="list" class="list"></div>

  <script>
    const listEl = document.getElementById('list');
    const statiEl = document.getElementById('stati');

    function parseOrderNumber(o){
      // 1) se c'è o.orderNumber usalo
      if (o.orderNumber != null) return Number(o.orderNumber);
      // 2) prova a leggere da notes "Ordine #N"
      if (o.notes){
        const m = String(o.notes).match(/#\s*(\d+)/i);
        if (m) return Number(m[1]);
      }
      // 3) fallback: ordina per createdAt (trasformato in numero crescente)
      return Date.parse(o.createdAt || 0);
    }

    function fmtItems(items){
      if(!items || !items.length) return '';
      return items.map(i => `${i.name} × ${i.qty||1}`).join(' • ');
    }

    function card(o){
      const n = parseOrderNumber(o);
      return `
        <div class="card">
          <div class="row">
            <div class="pill">ordine: <strong>${isNaN(n)?'-':n}</strong></div>
            <div class="pill">stato: <strong>${o.status}</strong></div>
            <div class="grow"></div>
            <div class="actions">
              <button class="btn btn-del" onclick="elimina('${o.id}')">elimina</button>
            </div>
          </div>
          <div class="items">${fmtItems(o.items)}</div>
          <div class="small" style="margin-top:6px">creato: ${o.createdAt ? new Date(o.createdAt).toLocaleString() : '-'}</div>
        </div>
      `;
    }

    async function load(){
      const status = statiEl.value;
      const url = `/getordini?status=${encodeURIComponent(status)}&sinceMinutes=1440`;
      const res = await fetch(url);
      const data = await res.json();

      // ordina per "numero ordine" ascendente (con fallback su createdAt)
      data.sort((a,b) => parseOrderNumber(a) - parseOrderNumber(b));

      listEl.innerHTML = data.map(card).join('');
    }


    async function elimina(id){
      if(!confirm('Eliminare questo ordine?')) return;
      const res = await fetch(`/deleteordine/${encodeURIComponent(id)}`, { method:'DELETE' });
      if(!res.ok){ alert('Errore eliminazione'); return; }
      await load();
    }

    document.getElementById('refreshBtn').onclick = load;
    statiEl.onchange = load;

    load();
    setInterval(load, 3000); // aggiornamento semplice
  </script>
</body>
</html>
